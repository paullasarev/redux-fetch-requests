"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var fp=require("lodash/fp"),lodash=require("lodash"),querystring=require("querystring");const FETCH_CANCEL_REQUESTS="FETCH_CANCEL_REQUESTS";function fetchCancelRequests(){return{type:FETCH_CANCEL_REQUESTS}}const hasRequest=fp.has("request"),responseTypes=["arraybuffer","blob","formData","json","text",null];function makeSuccessType(e){return`${e}_SUCCESS`}function makeErrorType(e){return`${e}_ERROR`}function makeCancelType(e){return`${e}_CANCEL`}function getResponseData(e,t){if(-1===responseTypes.indexOf(t))throw new Error(`responseType must be one of the following: ${responseTypes.map(String).join(", ")}`);return null===t?Promise.resolve(null):e[t]()}function isAbortError(e){return"AbortError"===e.name}async function fetchData(e,t,r,n){const{fetchInstance:a=fetch,baseUrl:s="",abortController:o,onRequest:c,onSuccess:u,onError:i,onCancel:l}=n,{request:{url:p,query:d={},responseType:f="json",isCancellable:y=!0,...E},meta:C}=e;try{const i=y&&o?{signal:o.signal}:void 0,l=lodash.isFunction(c)?c(E,e,t,r,n):E,T=querystring.encode(d),h=`${s}${p}${T?"?"+T:""}`,S=await a(h,{...i,...l});if(S.ok){S.data=await getResponseData(S,f);const a=lodash.isFunction(u)?u(S,e,t,r,n):S;return t({type:makeSuccessType(e.type),response:a,data:a.data,meta:C})}try{S.data=await S.json()}catch(e){}throw S}catch(a){const s=isAbortError(a),o=s?makeCancelType(e.type):makeErrorType(e.type),c=s?l:i;return lodash.isFunction(c)&&c(a,e,t,r,n),t({type:o,error:a,meta:C})}}function createMiddleware(e){const{abortController:t=new AbortController,cancelOn:r=[FETCH_CANCEL_REQUESTS]}=e;return({dispatch:n,getState:a})=>s=>o=>lodash.isArray(r)&&r.indexOf(o.type)>=0?(t.abort(),s(o)):lodash.isFunction(r)&&r(o)?(t.abort(),s(o)):hasRequest(o)?fetchData(o,n,a,e):s(o)}const defaultState=(e={})=>{const{getDefaultData:t,multiple:r=!1}=e;let n=r?[]:null;return lodash.isFunction(t)&&(n=t(e)),{data:n,error:null,pending:0}};function requestsReducer(e={}){const{actionType:t="UNKNOWN_ACTION",getData:r,getError:n,resetOn:a}=e,s=makeSuccessType(t),o=makeErrorType(t),c=makeCancelType(t);return(u,i)=>{let l=u;switch(lodash.isUndefined(u)&&(l=defaultState(e)),lodash.isArray(a)&&a.indexOf(i.type)>=0&&(l=defaultState(e)),lodash.isFunction(a)&&a(i)&&(l=defaultState(e)),i.type){case t:return{...l,pending:l.pending+1};case s:{const t=lodash.isFunction(r)?r(l,i,e):i.data;return{...l,data:t,pending:l.pending-1}}case c:case o:{const t=lodash.isFunction(n)?n(l,i,e):i.error;return{...l,error:t,pending:l.pending-1}}default:return l}}}exports.FETCH_CANCEL_REQUESTS=FETCH_CANCEL_REQUESTS,exports.createMiddleware=createMiddleware,exports.defaultState=defaultState,exports.fetchCancelRequests=fetchCancelRequests,exports.fetchData=fetchData,exports.getResponseData=getResponseData,exports.isAbortError=isAbortError,exports.makeCancelType=makeCancelType,exports.makeErrorType=makeErrorType,exports.makeSuccessType=makeSuccessType,exports.requestsReducer=requestsReducer;
